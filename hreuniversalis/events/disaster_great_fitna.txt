namespace = great_fitna

########################################
# The Great Fitna
########################################

# Start
country_event = {
	id = great_fitna.1
	title = "great_fitna.1.t"
	desc = "great_fitna.1.d"
	picture = CIVIL_WAR_eventPicture

	is_triggered_only = yes
	major = yes

	immediate = {
		hidden_effect = {
			random_owned_province = {
				limit = { NOT = { religion = ROOT } }
				spawn_rebels = {
					size = 3
					type = particularist_rebels
					win = yes
				}
			}
			random_owned_province = {
				limit = { NOT = { religion = ROOT } }
				spawn_rebels = {
					size = 3
					type = particularist_rebels
					win = yes
				}
			}
			random_owned_province = {
				limit = { NOT = { religion = ROOT } }
				spawn_rebels = {
					size = 3
					type = particularist_rebels
					win = yes
				}
			}
			random_owned_province = {
				limit = { NOT = { religion = ROOT } }
				spawn_rebels = {
					size = 3
					type = particularist_rebels
					win = yes
				}
			}
			random_owned_province = {
				limit = { NOT = { religion = ROOT } }
				spawn_rebels = {
					size = 3
					type = particularist_rebels
					win = yes
				}
			}
		}
	}

	option = {
		name = great_fitna.1.a
		add_stability = -3
		add_legitimacy = -25
		add_piety = -0.5
	}
}

# Mamluks plunder treasuries
country_event = {
	id = great_fitna.2
	title = "great_fitna.2.t"
	desc = "great_fitna.2.d"
	picture = BATTLE_eventPicture

	is_triggered_only = yes

	option = {
		name = great_fitna.2.a
		add_piety = -0.05
		add_years_of_income = -0.5
	}
	option = {
		name = great_fitna.2.b
		add_piety = 0.05
		add_mil_power = -25
	}
}

# Corrpution at court
country_event = {
	id = great_fitna.3
	title = "great_fitna.3.t"
	desc = "great_fitna.3.d"
	picture = CORRUPTION_eventPicture

	is_triggered_only = yes

	option = {
		name = great_fitna.3.a
		add_piety = -0.05
		add_corruption = 0.5
	}
	option = {
		name = great_fitna.3.b
		add_piety = 0.05
		add_dip_power = -25
	}
}

# Famine
country_event = {
	id = great_fitna.4
	title = "great_fitna.4.t"
	desc = "great_fitna.4.d"
	picture = FAMINE_eventPicture

	is_triggered_only = yes

	trigger = {
		any_owned_province = {
			NOT = { has_province_modifier = influenza }
		}
	}

	immediate = {
		random_owned_province = {
			limit = { NOT = { has_province_modifier = influenza } }
			save_event_target_as = famine_prov
		}
	}

	option = {
		name = great_fitna.3.a
		goto = famine_prov
		add_piety = -0.05
		random_owned_area = {
			limit = { owned_by = ROOT }
			add_devastation = 10
			add_province_modifier = {
				name = influenza
				duration = 365
			}
		}
	}
	option = {
		name = great_fitna.3.b
		add_piety = 0.05
		add_adm_power = -25
	}
}

#rebels
country_event = {
	id = great_fitna.5
	title = "great_fitna.5.t"
	desc = "great_fitna.5.d"
	picture = SIEGE_eventPicture
	goto = anarchy_prov

	is_triggered_only = yes

	trigger = {
		any_owned_province = {
			controlled_by = ROOT
		}
	}

	immediate = {
		hidden_effect = {
			random_list = {
				33 = { set_country_flag = reb_1_flag }
				33 = { set_country_flag = reb_2_flag }
				33 = { set_country_flag = reb_3_flag }
			}
			random_owned_province = {
				save_event_target_as = anarchy_prov
			}
		}
	}

	option = {
		name = great_fitna.5.a
		if = {
			limit = { has_country_flag = reb_1_flag }
			event_target:anarchy_prov = {
				spawn_rebels = {
					size = 1
					type = particularist_rebels
					win = yes
					unrest = 5
				}
			}
			clr_country_flag = reb_1_flag
		}
		else_if = {
			limit = { has_country_flag = reb_2_flag }
			event_target:anarchy_prov = {
				spawn_rebels = {
					size = 2
					type = particularist_rebels
					win = yes
					unrest = 5
				}
			}
			clr_country_flag = reb_2_flag
		}
		else_if = {
			limit = { has_country_flag = reb_3_flag }
			event_target:anarchy_prov = {
				spawn_rebels = {
					size = 3
					type = particularist_rebels
					win = yes
					unrest = 5
				}
			}
			clr_country_flag = reb_3_flag
		}
	}
}

#Hedjaz breaks off
country_event = {
	id = great_fitna.6
	title = "great_fitna.6.t"
	desc = "great_fitna.6.d"
	picture = PRAYING_eventPicture
	goto = hed_cap

	is_triggered_only = yes
	fire_only_once = yes

	trigger = {
		religion = shiite
		HED = {
			exists = yes
			ai = yes
			religion = shiite
			NOT = { war_with = ROOT }
			#owns
		}
	}

	immediate = {
		hidden_effect = {
			HED = {
				capital_scope = {
					save_event_target_as = hed_cap
				}
			}
		}
	}

	option = {
		name = great_fitna.6.a #spread shia islam with force
		ai_chance = { factor = 10 }
		add_piety = 0.2
		trigger = {
			HED = { is_free_or_tributary_trigger = yes }
		}
		add_legitimacy = 5
		declare_war_with_cb = {
			casus_belli = cb_heretic
			who = HED
		}
	}
	option = {
		name = great_fitna.6.b #corrupt
		ai_chance = { factor = 50 }
		add_piety = 0.1
		add_corruption = 3
	}
	option = {
		name = great_fitna.6.c #let them be
		ai_chance = { factor = 40 }
		add_piety = -0.2
		add_legitimacy = -5
		HED = {
			set_country_flag = avoid_choosing_madhhab_flag
			change_religion = sunni
			set_religious_school = {
				group = sunni
				school = hanafi_school
			}
			if = {
				limit = { is_subject_of = ROOT }
				add_liberty_desire = 50
			}
			add_opinion = {
				who = ROOT
				modifier = opinion_heretical_philosopher
			}
			reverse_add_opinion = {
				who = ROOT
				modifier = opinion_heretical_philosopher
			}
			clr_country_flag = avoid_choosing_madhhab_flag
		}
	}
}

# Ivite Badr Badr al-Jamali?
country_event = {
	id = great_fitna.7
	title = "great_fitna.7.t"
	desc = "great_fitna.7.d"
	picture = LAND_MILITARY_eventPicture

	is_triggered_only = yes
	fire_only_once = yes

	trigger = {
		any_owned_province = {
			controlled_by = ROOT
		}
	}

	immediate = {
		hidden_effect = {
			random_owned_province = {
				limit = { controlled_by = ROOT }
				save_event_target_as = jamali_reb_prov
			}
		}
	}

	option = {
		name = great_fitna.7.a
		ai_chance = { factor = 75 }
		add_piety = -0.1
		define_general = {
			name = "Badr al-Jamali"
			shock = 4
			fire = 3
			manuever = 4
			siege = 1
		}
		set_country_flag = badr_jamali_accepted
	}
	option = {
		name = great_fitna.7.b
		ai_chance = { factor = 25 }
		goto = jamali_reb_prov
		add_stability = -1
		add_piety = 0.1
		event_target:jamali_reb_prov = {
			spawn_rebels = {
				size = 3
				type = particularist_rebels
				leader = "Badr al-Jamali"
				unrest = 5
				win = yes
			}
		}
	}
}

# al-jamali seizes power
country_event = {
	id = great_fitna.8
	title = "great_fitna.8.t"
	desc = "great_fitna.8.d"
	picture = BATTLE_eventPicture

	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		has_country_flag = badr_jamali_accepted
		has_leader = "Badr al-Jamali"
	}

	immediate = {
		hidden_effect = {
			random_owned_province = {
				limit = { controlled_by = ROOT }
				save_event_target_as = jamali_reb_prov
			}
		}
	}

	option = {
		name = great_fitna.8.a
		add_piety = -0.25
		add_stability = 1
		add_disaster_modifier = {
			name = reign_of_terror_m
			duration = -1
			disaster = great_fitna
		}
		if = {
			limit = { has_estate = estate_mamluks }
			reduce_estate_mamluks_loyalty_effect = yes
		}
	}
	option = {
		name = great_fitna.8.b
		goto = jamali_prov
		add_piety = 0.25
		add_stability = -1
		event_target:jamali_reb_prov = {
			spawn_rebels = {
				size = 3
				type = particularist_rebels
				leader = "Badr al-Jamali"
				unrest = 5
				win = yes
			}
		}
		if = {
			limit = { has_estate = estate_mamluks }
			add_estate_mamluks_loyalty_effect = yes
		}
	}
}

# conflicts within the army
country_event = {
	id = great_fitna.9
	title = "great_fitna.9.t"
	desc = "great_fitna.9.d"
	picture = RELIGIOUS_WARS_eventPicture

	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		has_estate = estate_mamluks
	}

	option = {
		name = great_fitna.9.a # support the Turks
		add_piety = -0.2
		add_army_tradition = 10
		add_disaster_modifier = {
			name = army_quarrels_m
			duration = 5475
			disaster = great_fitna
		}
		add_estate_mamluks_loyalty_effect = yes
		add_estate_influence_modifier = {
			estate = estate_mamluks
			desc = EST_VAL_TURKISH_NUBIAN_SUPPORT
			influence = 15
			duration = 5475
		}
	}
	option = {
		name = great_fitna.9.b # support the opposition
		add_piety = 0.2
		add_legitimacy = 10
		add_disaster_modifier = {
			name = army_quarrels_m
			duration = 5475
			disaster = great_fitna
		}
		reduce_estate_mamluks_loyalty_effect = yes
		add_estate_influence_modifier = {
			estate = estate_mamluks
			desc = EST_VAL_TURKISH_NUBIAN_SUPPORT
			influence = -15
			duration = 5475
		}
	}
}

# curtail the viziers?
country_event = {
	id = great_fitna.10
	title = "great_fitna.10.t"
	desc = "great_fitna.10.d"
	picture = SPY_eventPicture

	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		NOT = { religion = sunni }
	}

	option = {
		name = great_fitna.10.a # yes
		add_piety = 0.2
		add_legitimacy = 10
		random_owned_province = {
			limit = { controlled_by = ROOT }
			spawn_rebels = {
				size = 3
				type = particularist_rebels
				win = yes
				unrest = 5
			}
		}
		random_owned_province = {
			limit = { controlled_by = ROOT }
			spawn_rebels = {
				size = 3
				type = particularist_rebels
				win = yes
				unrest = 5
			}
		}
		random_owned_province = {
			limit = { controlled_by = ROOT }
			spawn_rebels = {
				size = 3
				type = particularist_rebels
				win = yes
				unrest = 5
			}
		}
	}
	option = {
		name = great_fitna.10.b # no
		add_piety = 0.1
		add_prestige = -10
		add_disaster_modifier = {
			name = strong_viziers_m
			duration = 3650
			disaster = great_fitna
		}
	}
}

# sunni preachers
country_event = {
	id = great_fitna.11
	title = "great_fitna.11.t"
	desc = "great_fitna.11.d"
	picture = SPY_eventPicture
	goto = sunni_prov

	is_triggered_only = yes

	trigger = {
		religion_group = muslim
		NOT = { religion = sunni }
		any_owned_province = {
			religion_group = muslim
			NOT = { religion = sunni }
		}
	}

	immediate = {
		hidden_effect = {
			random_owned_province = {
				limit = {
					religion_group = muslim
					NOT = { religion = sunni }
				}
				save_event_target_as = sunni_prov
			}
		}
	}

	option = {
		name = great_fitna.11.a
		add_piety = -0.05
		event_target:sunni_prov = {
			change_religion = sunni
			add_local_autonomy = 50
		}
	}
	option = {
		name = great_fitna.11.b
		add_piety = 0.05
		event_target:sunni_prov = {
			change_religion = sunni
			spawn_rebels = {
				size = 2
				type = particularist_rebels
			}
		}
	}
}

# End
country_event = {
	id = great_fitna.100
	title = "great_fitna.100.t"
	desc = "great_fitna.100.d"
	picture = CIVIL_WAR_eventPicture

	is_triggered_only = yes
	major = yes

	option = {
		name = great_fitna.100.a
		add_stability_or_adm_power = yes
		clr_country_flag = badr_jamali_accepted
		clr_country_flag = sunni_viziers_tolerated
		clr_country_flag = sunni_viziers_curtailed
	}
}