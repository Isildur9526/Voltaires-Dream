namespace = investiture_controversy

#Start of the Investiture Controversy
country_event = {
	id = investiture_controversy.1
	title = "investiture_controversy.1.t"
	desc = "investiture_controversy.1.d"
	picture = HRE_eventPicture

	major = yes
	fire_only_once = yes

	trigger = {
		normal_or_historical_nations = yes
		current_age = age_of_empire
		NOT = { started_in = 1070.1.1 }
		is_emperor = yes
		religion = catholic
		papacy_active = yes
	}

	mean_time_to_happen = {
		months = 120
		modifier = {
			factor = 0.1
			hre_reform_level = 1
		}
	}

	option = {
		name = "investiture_controversy.1.a"
		ai_chance = { factor = 100 }
		custom_tooltip = investiture_controversy.1.tt
		add_opinion = {
			who = PAP
			modifier = opinion_investiture_controversy
		}
		reverse_add_opinion = {
			who = PAP
			modifier = opinion_investiture_controversy
		}
		add_ruler_modifier = {
			name = investiture_controversy_m
			duration = -1
		}
		hidden_effect = { set_global_flag = investiture_controversy_active }
	}
	option = {
		name = "investiture_controversy.1.b"
		ai_chance = { factor = 0 }
		add_corruption = 20
		add_imperial_influence = -50
		add_papal_influence = -50
	}
}

#Sets country flag when Emperor attacks 
country_event = {
    id = investiture_controversy.2
    title = "investiture_controversy.2.t"
    desc = "investiture_controversy.2.d"
	picture = BATTLE_eventPicture

    trigger = {
		any_country = {
			is_in_war = {
				attacker_leader = THIS
				defender_leader = ROOT
				casus_belli = cb_imperial_supremacy
			}
			NOT = { has_country_flag = imperial_supremacy_attacker }
		}
    }

    mean_time_to_happen = {
        months = 0
    }

    option = {
		name = "investiture_controversy.2.a"
		add_manpower = 2.5
		every_country = {
			limit = {
				is_in_war = {
					attacker_leader = THIS
					defender_leader = ROOT
					casus_belli = cb_imperial_supremacy
				}
				NOT = { has_country_flag = imperial_supremacy_attacker }
			}
			set_country_flag = imperial_supremacy_attacker
		}
    }
}

#War is lost by Emperor
country_event = {
    id = investiture_controversy.3
    title = "investiture_controversy.3.t"
    desc = "investiture_controversy.3.d"
    picture = WOUNDED_SOLDIERS_eventPicture

	is_triggered_only = yes

    trigger = {
		has_country_flag = imperial_supremacy_attacker
		NOT = { war_with = PAP }
    }

    option = {
		name = "investiture_controversy.3.a"
		add_legitimacy = -25
		clr_country_flag = imperial_supremacy_attacker
    }
}

#War is won by Emperor (also ends Investiture Controversy)
country_event = {
    id = investiture_controversy.4
    title = "investiture_controversy.4.t"
    desc = "investiture_controversy.4.d"
    picture = SIEGE_eventPicture

	fire_only_once = yes
	is_triggered_only = yes
	major = yes

    trigger = {
		has_country_flag = imperial_supremacy_attacker
		NOT = { war_with = PAP }
	}
	
	immediate = {
		hidden_effect = {
			clr_global_flag = investiture_controversy_active
			every_country = {
				clr_country_flag = imperial_supremacy_attacker
			}
		}
	}

    option = {
        name = "investiture_controversy.4.a"
		remove_country_modifier = investiture_controversy_m
		if = {
			limit = { is_excommunicated = yes }
			PAP = { excommunicate = ROOT }
		}
		add_prestige = 25
		add_imperial_influence = 25
        add_country_modifier = {
            name = investiture_controversy_won_m
            duration = 10950
		}
    }
}

#Ends Investiture Controversy by time
country_event = {
    id = investiture_controversy.5
    title = "investiture_controversy.5.t"
    desc = "investiture_controversy.5.d"
    picture = POPE_PREACHING_eventPicture

	fire_only_once = yes
	major = yes

    trigger = {
		NOT = { current_age = age_of_empire }
		has_global_flag = investiture_controversy_active
		tag = PAP
		papacy_active = yes
		NOT = {
			is_in_war = {
				casus_belli = cb_imperial_supremacy
			}
		}
		has_institution = investiture
	}
	
	mean_time_to_happen = {
		months = 120
	}

	immediate = {
		hidden_effect = {
			clr_global_flag = investiture_controversy_active
			every_country = {
				clr_country_flag = imperial_supremacy_attacker
			}
		}
	}

    option = {
        name = "investiture_controversy.5.a"
		add_prestige = 25
		add_devotion = 25
        add_country_modifier = {
            name = investiture_controversy_won_m
            duration = 10950
		}
    }
}

#Gives modifier if a new emperor is elected
country_event = {
	id = investiture_controversy.6
	title = "investiture_controversy.6.t"
	desc = "investiture_controversy.6.d"
	picture = HRE_eventPicture

	trigger = {
		has_global_flag = investiture_controversy_active
		is_emperor = yes
		religion = catholic
		papacy_active = yes
		NOT = { has_country_modifier = investiture_controversy_m }
	}

	mean_time_to_happen = {
		months = 0
	}

	option = {
		name = "investiture_controversy.6.a"
		custom_tooltip = investiture_controversy.1.tt
		add_opinion = {
			who = PAP
			modifier = opinion_investiture_controversy
		}
		reverse_add_opinion = {
			who = PAP
			modifier = opinion_investiture_controversy
		}
		add_ruler_modifier = {
			name = investiture_controversy_m
			duration = -1
		}
	}
}

###Flavor Events###
#New bishop for Milan
country_event = {
	id = investiture_controversy.7
	title = "investiture_controversy.7.t"
	desc = "investiture_controversy.7.d"
	picture = RELIGIOUS_TURMOIL_eventPicture

	fire_only_once = yes

	trigger = {
		normal_or_historical_nations = yes
		NOT = { started_in = 1070.1.1 }
		current_age = age_of_empire
		has_global_flag = investiture_controversy_active
		tag = MLO
		government = theocracy
		religion = catholic
		papacy_active = yes
	}

	mean_time_to_happen = {
		months = 60
	}

	option = {
		name = "investiture_controversy.7.a"
		ai_chance = {
			factor = 40
		}
		define_ruler = {
			name = "Attone"
			adm = 2
			dip = 1
			mil = 2
			fixed = yes
		}
		add_estate_loyalty = {
			estate = estate_church
			loyalty = 10
		}
		hidden_effect = {
			PAP = { country_event = { id = investiture_controversy.8 } }
		}
		reverse_add_opinion = {
			who = PAP
			modifier = opinion_pleased
		}
	}
	option = {
		name = "investiture_controversy.7.b"
		ai_chance = {
			factor = 40
		}
		define_ruler = {
			name = "Tedaldo"
			adm = 1
			dip = 0
			mil = 3
			fixed = yes
		}
		add_estate_loyalty = {
			estate = estate_nobles
			loyalty = 10
		}
		hidden_effect = {
			emperor = { country_event = { id = investiture_controversy.8 } }
		}
		reverse_add_opinion = {
			who = emperor
			modifier = opinion_pleased
		}
	}
	option = {
		name = "investiture_controversy.7.c"
		ai_chance = {
			factor = 20
		}
		kill_ruler = yes
		add_stability = -1
	}
}

#New bishop was elected in Milan
country_event = {
	id = investiture_controversy.8
	title = "investiture_controversy.8.t"
	desc = "investiture_controversy.8.d"
	picture = POPE_PREACHING_eventPicture

	is_triggered_only = yes
	mean_time_to_happen = { days = 1 }

	option = {
		name = "investiture_controversy.8.a"
		add_prestige = 10
		reverse_add_opinion = {
			who = FROM
			modifier = opinion_pleased
		}
	}
}

#Swabia becomes Anti-King
country_event = {
	id = investiture_controversy.9
	title = "investiture_controversy.9.t"
	desc = "investiture_controversy.9.d"
	picture = DIPLOMACY_eventPicture

	fire_only_once = yes
	major = yes

	trigger = {
		normal_or_historical_nations = yes
		NOT = { started_in = 1070.1.1 }
		is_year = 1070
		has_global_flag = investiture_controversy_active
		tag = WWS
		government = monarchy
		religion = catholic
		is_emperor = no
		has_regency = no
		is_free_or_tributary_trigger = yes
		is_part_of_hre = yes
		papacy_active = yes
	}

	mean_time_to_happen = { months = 120 }

	option = {
		name = "investiture_controversy.9.a"
		ai_chance = {
			factor = 90
			modifier = {
				factor = 0
				OR = {
					alliance_with = emperor
					NOT = { num_of_cities = 8 }
					is_at_war = yes
				}
			}
		}
		declare_war_with_cb = {
			who = emperor
			casus_belli = cb_fabricated_claims
		}
		add_prestige = 20
	}
	option = {
		name = "investiture_controversy.9.b"
		ai_chance = {
			factor = 90
			modifier = {
				factor = 0
				OR = {
					alliance_with = emperor
					NOT = { num_of_cities = 8 }
				}
			}
		}
		add_casus_belli = {
			type = cb_fabricated_claims
			months = 240
			target = emperor
		}
	}
	option = {
		name = "investiture_controversy.9.c"
		ai_chance = { factor = 10 }
		add_prestige = -5
	}
}

#Swabia is inherited by Hohenstaufers
country_event = {
	id = investiture_controversy.10
	title = "investiture_controversy.10.t"
	desc = "investiture_controversy.10.d"
	picture = BATTLE_eventPicture

	fire_only_once = yes
	major = yes

	trigger = {
		normal_or_historical_nations = yes
		NOT = { started_in = 1070.1.1 }
		is_year = 1070
		has_global_flag = investiture_controversy_active
		tag = WWS
		government = monarchy
		religion = catholic
		is_emperor = no
		is_free_or_tributary_trigger = yes
		is_part_of_hre = yes
		papacy_active = yes
		is_in_war = {
			attacker_leader = ROOT
			defender_leader = emperor
			casus_belli = cb_fabricated_claims
		}
		GMU = {
			government = monarchy
			exists = yes
			ai = yes
			dynasty = "von Hohenstaufen"
			is_emperor = no
			has_regency = no
		}
	}

	mean_time_to_happen = {
		months = 240
		modifier = {
			factor = 0.8
			NOT = { stability = 0 }
		}
		modifier = {
			factor = 0.8
			has_regency = yes
		}
		modifier = {
			factor = 0.8
			has_heir = no
		}
		modifier = {
			factor = 0.8
			is_monarch_leader = yes
		}
		modifier = {
			factor = 0.8
			NOT = {
				war_score_against = {
					who = emperor
					value = -50
				}
			}
		}
		modifier = {
			factor = 0.8
			NOT = {
				war_score_against = {
					who = emperor
					value = -75
				}
			}
		}
	}

	option = {
		name = "investiture_controversy.10.a"
		tooltip = {
			kill_ruler = yes
		}
		if = {
			limit = {
				has_heir = yes
			}
			remove_heir = yes
		}
		white_peace = emperor
		hidden_effect = {
			GMU = {
				exile_ruler_as = staufer_ruler
				exile_heir_as = staufer_heir
			}
			set_ruler = staufer_ruler
			set_heir = staufer_heir
		}
		inherit = GMU
	}
}

#Excommunicate the Emperor?
country_event = {
	id = investiture_controversy.11
	title = "investiture_controversy.11.t"
	desc = "investiture_controversy.11.d"
	picture = PRAYING_eventPicture

	fire_only_once = yes

	trigger = {
		normal_or_historical_nations = yes
		current_age = age_of_empire
		has_global_flag = investiture_controversy_active
		tag = PAP
		papacy_active = yes
		emperor = {
			religion = catholic
			has_regency = no
			is_excommunicated = no
		}
	}

	mean_time_to_happen = {
		months = 200
	}

	option = {
		name = "investiture_controversy.11.a"
		ai_chance = { factor = 75 }
		add_prestige = 10
		if = {
			limit = { emperor = { is_excommunicated = no } }
			excommunicate = emperor
		}
		reverse_add_opinion = {
			who = emperor
			modifier = opinion_angry
		}
		hidden_effect = {
			emperor = {
				country_event = {
					id = investiture_controversy.12
				}
			}
		}
	}
	option = {
		name = "investiture_controversy.11.b"
		ai_chance = { factor = 25 }
		add_prestige = -10
	}
}

#The Excommunication of the Emperor
country_event = {
	id = investiture_controversy.12
	title = "investiture_controversy.12.t"
	desc = "investiture_controversy.12.d"
	picture = POPE_PREACHING_eventPicture

	is_triggered_only = yes
	mean_time_to_happen = { days = 1 }

	option = {
		name = "investiture_controversy.12.a"
		reverse_add_opinion = {
			who = FROM
			modifier = opinion_angry
		}
	}
}

#Start the Walk to Canossa?
country_event = {
	id = investiture_controversy.13
	title = "investiture_controversy.13.t"
	desc = "investiture_controversy.13.d"
	picture = RELIGION_eventPicture

	fire_only_once = yes

	trigger = {
		normal_or_historical_nations = yes
		current_age = age_of_empire
		has_global_flag = investiture_controversy_active
		is_emperor = yes
		is_excommunicated = yes
		is_at_war = no
	}

	mean_time_to_happen = {
		months = 60
	}

	option = {
		name = "investiture_controversy.13.a"
		ai_chance = { factor = 90 }
		add_years_of_income = -0.5
		add_yearly_manpower = -0.5
		PAP = {
			country_event = {
				id = investiture_controversy.14
				days = 60
			}
		}
	}
	option = {
		name = "investiture_controversy.13.b"
		ai_chance = { factor = 10 }
		add_prestige = 1
	}
}

#Lift the Excommunication?
country_event = {
	id = investiture_controversy.14
	title = "investiture_controversy.14.t"
	desc = "investiture_controversy.14.d"
	picture = FORT_eventPicture

	is_triggered_only = yes
	mean_time_to_happen = { days = 1 }

	option = {
		name = "investiture_controversy.14.a"
		ai_chance = { factor = 90 }
		add_prestige = 10
		if = {
			limit = { FROM = { is_excommunicated = yes } }
			excommunicate = FROM
		}
		hidden_effect = {
			FROM = {
				country_event = {
					id = investiture_controversy.15
				}
			}
		}
	}
	option = {
		name = "investiture_controversy.14.b"
		ai_chance = { factor = 10 }
		add_prestige = -10
		hidden_effect = {
			FROM = {
				country_event = {
					id = investiture_controversy.16
				}
			}
		}
	}
}

#The Excommunication is lifted
country_event = {
	id = investiture_controversy.15
	title = "investiture_controversy.15.t"
	desc = "investiture_controversy.15.d"
	picture = POPE_PREACHING_eventPicture

	is_triggered_only = yes
	mean_time_to_happen = { days = 1 }

	option = {
		name = "investiture_controversy.15.a"
		add_prestige = 10
	}
}

#The Excommunication is not lifted
country_event = {
	id = investiture_controversy.16
	title = "investiture_controversy.16.t"
	desc = "investiture_controversy.16.d"
	picture = WOUNDED_SOLDIERS_eventPicture

	is_triggered_only = yes
	mean_time_to_happen = { days = 1 }

	option = {
		name = "investiture_controversy.16.a"
		add_prestige = -10
	}
}